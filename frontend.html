<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Reserva de Cruzeiros</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: auto;
      padding: 1rem;
    }
    textarea {
      width: 100%;
      height: 100px;
    }
    button {
      margin: 0.2rem 0;
    }
  </style>
</head>
<body>
  <h1>Sistema de Reservas</h1>

  <h2>Seu ID</h2>
  <p id="idExibido" style="font-weight: bold;"></p>

  <h2>Consultar Itinerários</h2>
  <input id="destino" placeholder="Destino" />
  <input id="data" placeholder="Data de embarque (AAAA-MM-DD)" />
  <input id="porto" placeholder="Porto de embarque" />
  <button onclick="consultar()">Consultar</button>
  <button onclick="verTodos()">Ver Todos os Itinerários</button>
  <pre id="resultado"></pre>

  <h2>Efetuar Reserva</h2>
  <input id="dataReserva" placeholder="Data de embarque" />
  <input id="qtdPassageiros" placeholder="Qtd passageiros" />
  <input id="qtdCabines" placeholder="Qtd cabines" />
  <input id="valor" placeholder="Valor total" />
  <button onclick="reservar()">Reservar</button>
  <pre id="linkPagamento"></pre>

  <h2>Minhas Reservas</h2>
  <button onclick="verReservas()">Ver</button>
  <pre id="minhas-reservas"></pre>

  <h2>Cancelar Reserva</h2>
  <input id="idReserva" placeholder="ID da reserva" />
  <button onclick="cancelarReserva()">Cancelar</button>
  <pre id="cancelamento"></pre>

  <h2>Gerenciar Notificações</h2>
  <button onclick="registrarInteresse()">Registrar Interesse em Promoções</button>
  <button onclick="cancelarInteresse()">Cancelar Interesse</button>
  <pre id="interesse-status"></pre>

  <h2>Notificações</h2>
  <pre id="sse"></pre>

  <script>
    const apiUrl = "http://localhost:5000";

    function gerarUUID() {
      return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
      );
    }

    function obterClientId() {
      let id = localStorage.getItem("client_id");
      if (!id) {
        id = gerarUUID();
        localStorage.setItem("client_id", id);
      }
      document.getElementById("idExibido").textContent = `ID do Cliente: ${id}`;
      return id;
    }

    function getClientId() {
      return localStorage.getItem("client_id");
    }

    async function verTodos() {
      const res = await fetch(`${apiUrl}/itinerarios`);
      const dados = await res.json();
      document.getElementById("resultado").textContent = JSON.stringify(dados, null, 2);
    }

    async function consultar() {
      const destino = document.getElementById("destino").value;
      const data = document.getElementById("data").value;
      const porto = document.getElementById("porto").value;

      const res = await fetch(`${apiUrl}/itinerarios?destino=${destino}&data=${data}&porto=${porto}`);
      const dados = await res.json();
      document.getElementById("resultado").textContent = JSON.stringify(dados, null, 2);
    }

    async function reservar() {
      const data = document.getElementById("dataReserva").value;
      const passageiros = parseInt(document.getElementById("qtdPassageiros").value);
      const cabines = parseInt(document.getElementById("qtdCabines").value);
      const valor = parseFloat(document.getElementById("valor").value);
      const client_id = getClientId();

      const res = await fetch(`${apiUrl}/reservar`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data, passageiros, cabines, valor, client_id })
      });
      const dados = await res.json();
      document.getElementById("linkPagamento").textContent = JSON.stringify(dados, null, 2);
    }

    async function verReservas() {
      const client_id = getClientId();
      const res = await fetch(`${apiUrl}/reservas/${client_id}`);
      const dados = await res.json();
      document.getElementById("minhas-reservas").textContent = JSON.stringify(dados, null, 2);
    }

    async function cancelarReserva() {
      const reserva_id = document.getElementById("idReserva").value;
      const client_id = getClientId();
      const res = await fetch(`${apiUrl}/cancelar-reserva`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ reserva_id, client_id })
      });
      const dados = await res.json();
      document.getElementById("cancelamento").textContent = JSON.stringify(dados, null, 2);
    }

    async function registrarInteresse() {
      const client_id = getClientId();
      const res = await fetch(`${apiUrl}/interesse`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ client_id })
      });
      const dados = await res.json();
      document.getElementById("interesse-status").textContent = JSON.stringify(dados, null, 2);
    }

    async function cancelarInteresse() {
      const client_id = getClientId();
      const res = await fetch(`${apiUrl}/cancelar-interesse`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ client_id })
      });
      const dados = await res.json();
      document.getElementById("interesse-status").textContent = JSON.stringify(dados, null, 2);
    }

    function escutarNotificacoes() {
      const client_id = getClientId();
      const sse = new EventSource(`${apiUrl}/sse/${client_id}`);

      sse.onmessage = (event) => {
        const sseDiv = document.getElementById("sse");
        sseDiv.textContent += `\n${event.data}`;
      };
    }

    window.addEventListener("load", () => {
      obterClientId();
      escutarNotificacoes();
    });
  </script>
</body>
</html>
